### 语法

1、尾随逗号，除了git版本控制差异外，使用它可以不担心多添加了额外的逗号，或者是落下逗号。php8.0支持在数组、函数调用、参数列表和闭包使用语句中。

2、格式化数字值，用下划线，当代码解析时，下划线完全被忽略，它可以使长数字更容易被人类阅读。

![[Pasted image 20231108204247.png]]![[Pasted image 20231108204349.png]]

3、匿名类
php7.0加的，用来创建即时对象，甚至可以扩展一个基类。

4、heredoc,对于长字符串有非常有用。

```
<<<SQL SQL
```

heredoc以前在结束界定前面有任何空格，php8可以有.

5、PHP8.0中新增的两个较小的功能。
- throw语句是个表达式，意味着可以在更多的地方使用，比如空合并运算符的右操作数中，或者在短闭包中。

```
// Invalid before PHP 8.0
$name = $input['name'] ?? throw new NameNotFound();

// Valid as of PHP 8.0
$name = $input['name'] ?? throw new NameNotFound();
$error = fn (string $class) => throw new $class();

```
- 异常捕获，捕获到异常依然保持程序运转不执行任何操作，但必须分配一个变量
```
try {
	// Something goes wrong
} catch (Exception) {
	// Just continue
}
```

6、弱引用 weak references, php7.4添加的新概念

>  每当创建一个对象，都需要一些内存来跟踪其状态。如果创建一个对象并将其分配给一个变量，变量就是对该对象的引用。一旦没有对象的引用，它就不能再被使用，保存在内存也就没有意义，这就是为什么垃圾收集器有时会寻找这些对象并将其移除，释放内存。

>弱引用是指不会阻止对象被垃圾回收的引用。这个特性本身看起来有点奇怪，但结合弱映射，它们允许在 php8.0 中有一个有趣的用例：结合了弱映射，使用弱引用来引用对象的映射。

>以ORM为例，它们通常实现保存对实体类引用的高速缓存，以提高实体之间关系的性能。这些实体对象不能被垃圾回收，只要这个缓存引用它们，即使该高速缓存是唯一引用它们的东西。

>如果这个缓存层使用弱引用和映射，php将在没有其他对象引用它们时对这些对象进行垃圾回收。特别是在ORM的情况下，它可以在一个请求中管理数百甚至数千个实体；弱映射可以提供更好，更节约资源的方式来处理这些对象。

php 8.0 WeakMap + weak references,因为弱映射，如果没有其他引用过，就可以对它垃圾回收。

 `laravel 10`使用的日志扩展包`Monolog/Monolog`中使用`WeakMap`用于将`Fiber`实例和它们的日志深度相关联。下面分析一下在这种情况下使用`WeakMap`的原因：

1、避免内存泄漏：WeakMap对其键（在这种情况下是Fiber的实例）持有弱引用。
弱引用该不会阻止被引用的对象Fiber被垃圾回收。这在日志库中非常重要，
因为日志库通常会伴随整个应用程序运行，如果持有fibers的强引用可能会导致内存泄露。
2、防止无限循环：注释指出这个WeakMap用于跟踪在fibers内部的日志深度，
以防止无限的日志循环。php中的fibers本质上是用于并发的轻量级线程。
在fibers中执行日志操作时，避免日志本身触发更多无控制的日志是至关重要的，
这可能会导致栈溢出或内存耗尽。
通过跟踪日志调用深度，Monolog可以防止重入式日志导致问题。
3、生命周期管理：通过使用WeakMap,日志深度状态的生命周期自动由fiber对象本身
的生命周期管理。当fiber对象在应用程序中不再被任何地方引用并被垃圾回收时，
它在WeakMap中关联的日志深度也会被清理。
这有助于状态的自动和高效管理，无需显示的移出和检查。

总结来说，Monolog利用了php的WeakMap功能，
以内存高效的方式管理与fibers相关的状态，
并防止fibers内部递归日志潜在的问题。
这是一种明智的使用特性。
确保日志器内部状态不会干扰应用程序的状态或资源管理。

6、php8.0中引入JIT即时编译器，是php8中添加的核心机制，可以显著加快php运行速度。



7、php8.0中可以用变量，快速获取完整类名并加载

```

$className = $offer::class;

```

8、php8.0中 == 比较规则发生了改变

9、php8.1 添加了新的array_is_list函数，检查数组是否从0开始并以1递增的数字键的函数。

10、更改错误控制运算符
1个显著的变化是@运算符不再消除致命错误

11、从php8.1开始可以用0o或0O表示8进制数。以前的做法是直接在数字前面加0，也是有效的。

![[Pasted image 20231109011201.png]]

12、php8.1 final + 类常量,允许声明类常量为final
与您可能一开始认为的相反，类常量是可以被重写的。这就是为什么允许它们是个final是个很好的补充。

```
class Foo{
	final public const x = 'foo';
}

class Bar extends Foo{
	public const x = 'bar';
}

```

13、在php 7.4中,php的核心添加了两个低级组件： FFI和预加载。这两个主题本身都很复杂，各自有自己的章节。

FFI 外部函数接口，允许php直接与共享库（例如c语言编写的）进行交互。换句话说：可以编写php扩展并将其作为composer软件包发布，而无需安装低级php扩展本身。

另一个是预加载，它使您能够在服务器启动时编译php代码。该代码将保存在内存中，供所有后续请求使用。这可以加快您的平均php网络框架，因为它不再需要在每个请求上启动。